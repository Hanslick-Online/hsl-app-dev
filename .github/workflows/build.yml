name: Build and publish

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build_pages:
    name: Build HTML pages
    runs-on: ubuntu-latest
    env:
      ANT_OPTS: -Xmx5g
    steps:
      - name: Perform checkout
        uses: actions/checkout@v5

      - name: Setup Java / Ant
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "11"

      - name: Fetch static-app skeleton
        run: ./fetch_data_app.sh

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          # cache-dependency-path: build_app/python/requirements.txt

      - name: Install Python libraries
        run: |
          python -m pip install -U pip
          pip install -r build_app/python/requirements.txt

      - name: Fetch data
        run: |
          chmod +x build_app/shell/* build_app/python/*
          ./build_app/shell/fetch_data.sh

      - name: Install Saxon, Ant and Fundament
        run: ./build_app/shell/script.sh

      - name: preprocess
        run: ant -f build_app/ant/preprocess.xml

      - name: add attributes and denormalize indices
        run: |
          ./build_app/shell/attributes.sh
          ./build_app/shell/denormalize.sh

      - name: Fix TEI
        run: ant -f build_app/ant/fixtures.xml

      - name: Build
        run: ant -f build_app/ant/build.xml

      - name: Upload build inputs for downstream jobs
        uses: actions/upload-artifact@v4
        with:
          name: data-artifact
          compression-level: 1
          retention-days: 1
          path: |
            html
            data
            build_app
            fetch_data_app.sh
            !**/.git/**
            !**/.github/**
            !**/tmp/**
            !**/__pycache__/**
            !**/*.pyc

  compile_latex:
    name: Produce PDF files
    runs-on: ubuntu-latest
    needs: build_pages
    steps:
      - name: Download data-artifact
        uses: actions/download-artifact@v4
        with:
          name: data-artifact
          path: .

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: build_app/python/requirements.txt

      - name: Install Python libs
        run: |
          python -m pip install -U pip
          pip install -r build_app/python/requirements.txt

      - name: Install TeX Live (minimal set for xelatex)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-xetex \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-plain-generic \
            texlive-fonts-recommended \
            texlive-lang-german \
            fonts-noto-core
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Transform XML-TEI to LaTeX
        run: |
          set -euo pipefail
          chmod +x build_app/python/xml2latex.py
          mkdir -p tmp/tex html/pdf
          for dir in traktat vms critics doc; do
            find "data/$dir/editions" -type f -name "*.xml" -print0 | \
              while IFS= read -r -d '' filepath; do
                base="${filepath##*/}"
                out="tmp/tex/${base%.xml}.tex"
                build_app/python/xml2latex.py "$filepath" "$out"
              done
          done

      - name: Compile LaTeX to PDF (keep only PDFs)
        run: |
          set -euo pipefail
          mkdir -p tmp/latex-out html/pdf
          find tmp/tex -type f -name "*.tex" -print0 | \
            while IFS= read -r -d '' tex; do
              xelatex -interaction=nonstopmode -halt-on-error -file-line-error \
                -output-directory="tmp/latex-out" "$tex"
            done
          find tmp/latex-out -type f -name "*.pdf" -exec mv -t html/pdf {} +
          rm -rf tmp/tex tmp/latex-out

      - name: Free disk space before Pages packaging
        run: |
          df -h
          df -i
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android || true
          rm -rf ~/.cache/pip ~/.cache || true
          df -h
          df -i

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload full site artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: html

  type_sense:
    name: Reindex TypeSense
    runs-on: ubuntu-latest
    needs: build_pages
    env:
      TYPESENSE_HOST: typesense.acdh-dev.oeaw.ac.at
      TYPESENSE_PORT: 443
      TYPESENSE_PROTOCOL: https
      TYPESENSE_API_KEY: ${{ secrets.TYPESENSE_API_KEY }}
    steps:
      - name: Download data-artifact
        uses: actions/download-artifact@v4
        with:
          name: data-artifact
          path: .

  deploy:
    runs-on: ubuntu-latest
    needs: compile_latex
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
